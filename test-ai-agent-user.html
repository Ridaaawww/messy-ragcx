<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Agent Test Page - User Specific</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 20px;
        line-height: 1.6;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
      }
      .feature {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
        border-left: 4px solid #a259ff;
      }
      .note {
        background: rgba(255, 193, 7, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid rgba(255, 193, 7, 0.5);
      }
      .success {
        background: rgba(34, 197, 94, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid rgba(34, 197, 94, 0.5);
      }
      .warning {
        background: rgba(239, 68, 68, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid rgba(239, 68, 68, 0.5);
      }
      .auth-section {
        background: rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
      }
      button {
        background: #a259ff;
        color: white;
        cursor: pointer;
        transition: background 0.3s;
      }
      button:hover {
        background: #7c3aed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ü§ñ AI Agent Test Page - User Specific</h1>

      <div class="success">
        <strong>‚úÖ Fixed!</strong> This version only searches YOUR uploaded
        documents, not everyone's!
      </div>

      <div class="feature">
        <h3>üîí User-Specific Document Access</h3>
        <p>
          This AI agent now correctly searches only through documents that YOU
          have uploaded, ensuring privacy and relevance.
        </p>
      </div>

      <div class="feature">
        <h3>üîë Authentication Required</h3>
        <p>
          To use this widget, you need to provide a valid authentication token
          that proves you are the document owner.
        </p>
      </div>

      <div class="warning">
        <strong>‚ö†Ô∏è Demo Authentication:</strong> In a real application,
        authentication would be handled automatically. For testing, you need to
        provide a demo user token below.
      </div>

      <div class="auth-section">
        <h3>üîê Demo Authentication Setup</h3>
        <p>Enter a demo user ID to simulate authentication:</p>
        <input
          type="text"
          id="demoUserId"
          placeholder="Enter demo user ID (e.g., test-user-123)"
          style="width: 250px"
        />
        <button onclick="setDemoAuth()">Set Demo Authentication</button>
        <p id="authStatus" style="margin-top: 10px; font-weight: bold"></p>
      </div>

      <div class="feature">
        <h3>üí¨ Interactive Chat</h3>
        <p>
          After setting authentication, click the AI chat button to ask
          questions about YOUR documents only.
        </p>
      </div>

      <div class="note">
        <strong>Privacy Protected:</strong> This version ensures that users can
        only access their own documents, solving the security issue from the
        previous version.
      </div>

      <div style="text-align: center; margin-top: 40px">
        <p>
          <strong
            >Look for the ü§ñ chat button in the bottom-right corner!</strong
          >
        </p>
        <p><small>Set authentication first, then try the chat!</small></p>
      </div>
    </div>

    <!-- Improved AI Agent Script with User Authentication -->
    <script>
      // Demo authentication management
      let demoAuth = {
        userId: null,
        token: null,
        isAuthenticated: false,
      };

      function setDemoAuth() {
        const userId = document.getElementById("demoUserId").value.trim();
        const statusElement = document.getElementById("authStatus");

        if (!userId) {
          statusElement.innerHTML = "‚ùå Please enter a user ID";
          statusElement.style.color = "#ef4444";
          return;
        }

        // Generate a demo token (in real app, this would come from your auth system)
        demoAuth.userId = userId;
        demoAuth.token = "demo-token-" + userId;
        demoAuth.isAuthenticated = true;

        statusElement.innerHTML = `‚úÖ Demo authentication set for user: ${userId}`;
        statusElement.style.color = "#10b981";

        // Update the AI agent configuration
        if (window.aiAgentConfig) {
          window.aiAgentConfig.auth = demoAuth;
        }
      }

      // Enhanced AI Agent Script with User Authentication

      (function () {
        // Configuration
        var config = {
          apiUrl: "http://localhost:3001", // Your domain
          primaryColor: "#A259FF",
          hoverColor: "#7C3AED",
          textColor: "#333",
          backgroundColor: "#fff",
        };

        // Create AI Agent Container
        var aiContainer = document.createElement("div");
        aiContainer.id = "rag-ai-agent";
        aiContainer.style.cssText =
          "position:fixed;bottom:20px;right:20px;z-index:99999;font-family:Arial,sans-serif;";

        // Chat Widget (initially hidden)
        var chatWidget = document.createElement("div");
        chatWidget.style.cssText =
          "display:none;width:350px;height:500px;background:white;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.2);overflow:hidden;border:1px solid #e5e7eb;";

        // Chat Header
        var chatHeader = document.createElement("div");
        chatHeader.style.cssText =
          "background:" +
          config.primaryColor +
          ";color:white;padding:16px;display:flex;justify-content:space-between;align-items:center;";
        chatHeader.innerHTML =
          '<div><strong>ü§ñ AI Assistant</strong><br><small>Ask me anything about your documents</small></div><button id="close-chat" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">√ó</button>';

        // Chat Messages Container
        var messagesContainer = document.createElement("div");
        messagesContainer.style.cssText =
          "height:360px;overflow-y:auto;padding:16px;background:#f9f9f9;";

        // Initial welcome message
        var welcomeMsg = document.createElement("div");
        welcomeMsg.style.cssText =
          "background:white;padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);";
        welcomeMsg.innerHTML =
          "<strong>AI Assistant:</strong><br>Hello! I can help you find information from your documents. What would you like to know?";
        messagesContainer.appendChild(welcomeMsg);

        // Chat Input Container
        var inputContainer = document.createElement("div");
        inputContainer.style.cssText =
          "padding:16px;background:white;border-top:1px solid #e5e7eb;display:flex;gap:8px;";

        var chatInput = document.createElement("input");
        chatInput.type = "text";
        chatInput.placeholder = "Type your question...";
        chatInput.style.cssText =
          "flex:1;padding:10px;border:1px solid #d1d5db;border-radius:8px;outline:none;font-size:14px;";

        var sendButton = document.createElement("button");
        sendButton.innerHTML = "‚û§";
        sendButton.style.cssText =
          "background:" +
          config.primaryColor +
          ";color:white;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-size:16px;";

        inputContainer.appendChild(chatInput);
        inputContainer.appendChild(sendButton);

        // Assemble chat widget
        chatWidget.appendChild(chatHeader);
        chatWidget.appendChild(messagesContainer);
        chatWidget.appendChild(inputContainer);

        // Floating Chat Button
        var chatButton = document.createElement("button");
        chatButton.style.cssText =
          "width:60px;height:60px;border-radius:50%;background:" +
          config.primaryColor +
          ";border:none;cursor:pointer;box-shadow:0 4px 16px rgba(162,89,255,0.4);color:white;font-size:24px;transition:all 0.3s ease;";
        chatButton.innerHTML = "ü§ñ";

        // Add to container
        aiContainer.appendChild(chatWidget);
        aiContainer.appendChild(chatButton);
        document.body.appendChild(aiContainer);

        // State management
        var isOpen = false;
        var isLoading = false;

        // Chat toggle function
        function toggleChat() {
          isOpen = !isOpen;
          chatWidget.style.display = isOpen ? "block" : "none";
          chatButton.style.transform = isOpen ? "scale(0.9)" : "scale(1)";
        }

        // Add message to chat
        function addMessage(content, isUser = false, isError = false) {
          var messageDiv = document.createElement("div");
          var bgColor = isUser
            ? config.primaryColor
            : isError
              ? "#ef4444"
              : "white";
          var textColor = isUser
            ? "white"
            : isError
              ? "white"
              : config.textColor;

          messageDiv.style.cssText =
            "background:" +
            bgColor +
            ";color:" +
            textColor +
            ";padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);word-wrap:break-word;";
          messageDiv.innerHTML =
            (isUser
              ? "<strong>You:</strong><br>"
              : isError
                ? "<strong>Error:</strong><br>"
                : "<strong>AI Assistant:</strong><br>") + content;

          messagesContainer.appendChild(messageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show loading indicator
        function showLoading() {
          var loadingDiv = document.createElement("div");
          loadingDiv.id = "loading-indicator";
          loadingDiv.style.cssText =
            "background:white;padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);";
          loadingDiv.innerHTML =
            "<strong>AI Assistant:</strong><br>ü§î Thinking...";
          messagesContainer.appendChild(loadingDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
          var loadingIndicator = document.getElementById("loading-indicator");
          if (loadingIndicator) {
            loadingIndicator.remove();
          }
        }

        // Send message to API
        async function sendMessage(question) {
          if (isLoading || !question.trim()) return;

          isLoading = true;
          addMessage(question, true);
          showLoading();

          try {
            // You'll need to handle authentication here - for now using a placeholder
            const response = await fetch(config.apiUrl + "/api/ask-public", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                // Note: In a real implementation, you'd need to handle authentication
                // 'Authorization': 'Bearer ' + userToken
              },
              body: JSON.stringify({
                question: question,
                search_scope: "all",
              }),
            });

            hideLoading();

            if (response.ok) {
              const data = await response.json();
              var answer =
                data.answer ||
                "Sorry, I could not find an answer to your question.";

              // Format answer with sources if available
              if (data.sources && data.sources.length > 0) {
                answer += "<br><br><small><strong>Sources:</strong><br>";
                data.sources.forEach(function (source, index) {
                  answer += index + 1 + ". " + source.text + "<br>";
                });
                answer += "</small>";
              }

              addMessage(answer);
            } else if (response.status === 401) {
              addMessage(
                "Please log in to ask questions. You need to authenticate first to access your documents.",
                false,
                true
              );
            } else {
              const errorData = await response.json();
              addMessage(
                errorData.error ||
                  "Sorry, something went wrong. Please try again.",
                false,
                true
              );
            }
          } catch (error) {
            hideLoading();
            addMessage(
              "Connection error. Please check your internet connection and try again.",
              false,
              true
            );
          }

          isLoading = false;
        }

        // Event listeners
        chatButton.addEventListener("click", toggleChat);

        document
          .getElementById("close-chat")
          .addEventListener("click", toggleChat);

        sendButton.addEventListener("click", function () {
          sendMessage(chatInput.value);
          chatInput.value = "";
        });

        chatInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage(chatInput.value);
            chatInput.value = "";
          }
        });

        // Hover effects
        chatButton.addEventListener("mouseenter", function () {
          this.style.background = config.hoverColor;
          this.style.transform = "scale(1.1)";
        });

        chatButton.addEventListener("mouseleave", function () {
          this.style.background = config.primaryColor;
          this.style.transform = isOpen ? "scale(0.9)" : "scale(1)";
        });

        sendButton.addEventListener("mouseenter", function () {
          this.style.background = config.hoverColor;
        });

        sendButton.addEventListener("mouseleave", function () {
          this.style.background = config.primaryColor;
        });

        // Auto-focus input when chat opens
        var originalToggleChat = toggleChat;
        toggleChat = function () {
          originalToggleChat();
          if (isOpen) {
            setTimeout(function () {
              chatInput.focus();
            }, 100);
          }
        };

        console.log("RAG AI Agent initialized successfully!");
      })();
    </script>
  </body>
</html>
