<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #A259FF;
        }
        .note {
            background: rgba(255, 193, 7, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid rgba(255, 193, 7, 0.5);
        }
        .success {
            background: rgba(34, 197, 94, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ AI Agent Test Page</h1>
        
        <div class="success">
            <strong>‚úÖ CORS Issues Fixed!</strong> This test page is now served from the same domain as your API, eliminating cross-origin issues.
        </div>
        
        <div class="feature">
            <h3>üìÑ Document Q&A System</h3>
            <p>This page demonstrates the AI Agent that can answer questions about uploaded documents using RAG (Retrieval Augmented Generation) technology.</p>
        </div>
        
        <div class="feature">
            <h3>üí¨ Interactive Chat</h3>
            <p>Click the AI chat button in the bottom-right corner to start asking questions. The AI will search through available documents to provide relevant answers.</p>
        </div>
        
        <div class="feature">
            <h3>üîç Smart Search</h3>
            <p>The AI uses keyword and semantic search to find the most relevant information from documents, even if your question doesn't contain exact keywords.</p>
        </div>
        
        <div class="note">
            <strong>Demo Mode:</strong> This test uses a public API endpoint that searches through available documents. In the full system, users would have access to their personal authenticated document library.
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <p><strong>Look for the ü§ñ chat button in the bottom-right corner!</strong></p>
            <p><small>Try asking questions like: "What is this about?", "Tell me about the content", or any specific topic.</small></p>
            <button onclick="alert('Page is working! Check browser console for AI agent logs.')" style="background:#A259FF;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-top:10px;">Test Page</button>
        </div>
    </div>

    <!-- AI Agent Script with Public API -->
    <script>
(function() {
  console.log('AI Agent script starting...');
  
  // Configuration - point to Next.js server regardless of current domain
  var config = {
    apiUrl: 'http://localhost:3000', // Always use Next.js server
    primaryColor: '#A259FF',
    hoverColor: '#7C3AED',
    textColor: '#333',
    backgroundColor: '#fff'
  };

  console.log('Config loaded:', config);

  // Create AI Agent Container
  var aiContainer = document.createElement('div');
  aiContainer.id = 'rag-ai-agent';
  aiContainer.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:99999;font-family:Arial,sans-serif;';

  console.log('AI Container created');

  // Floating Chat Button (create this first and make it visible)
  var chatButton = document.createElement('button');
  chatButton.style.cssText = 'width:60px;height:60px;border-radius:50%;background:' + config.primaryColor + ';border:none;cursor:pointer;box-shadow:0 4px 16px rgba(162,89,255,0.4);color:white;font-size:24px;transition:all 0.3s ease;';
  chatButton.innerHTML = 'ü§ñ';

  console.log('Chat button created');

  // Add button to container and container to body immediately
  aiContainer.appendChild(chatButton);
  document.body.appendChild(aiContainer);

  console.log('Button added to DOM');

  // Chat Widget (initially hidden)
  var chatWidget = document.createElement('div');
  chatWidget.style.cssText = 'display:none;width:350px;height:500px;background:white;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.2);overflow:hidden;border:1px solid #e5e7eb;position:absolute;bottom:70px;right:0;';

  // Chat Header
  var chatHeader = document.createElement('div');
  chatHeader.style.cssText = 'background:' + config.primaryColor + ';color:white;padding:16px;display:flex;justify-content:space-between;align-items:center;';
  
  var headerContent = document.createElement('div');
  headerContent.innerHTML = '<strong>ü§ñ AI Assistant</strong><br><small>Ask me anything about the documents</small>';
  
  var closeButton = document.createElement('button');
  closeButton.innerHTML = '√ó';
  closeButton.style.cssText = 'background:none;border:none;color:white;font-size:20px;cursor:pointer;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;';
  
  chatHeader.appendChild(headerContent);
  chatHeader.appendChild(closeButton);

  // Chat Messages Container
  var messagesContainer = document.createElement('div');
  messagesContainer.style.cssText = 'height:320px;overflow-y:auto;padding:16px;background:#f9f9f9;';
  
  // Initial welcome message
  var welcomeMsg = document.createElement('div');
  welcomeMsg.style.cssText = 'background:white;padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);';
  welcomeMsg.innerHTML = '<strong>AI Assistant:</strong><br>Hello! I can help you find information from available documents. What would you like to know?';
  messagesContainer.appendChild(welcomeMsg);

  // Chat Input Container
  var inputContainer = document.createElement('div');
  inputContainer.style.cssText = 'padding:16px;background:white;border-top:1px solid #e5e7eb;display:flex;gap:8px;min-height:70px;box-sizing:border-box;';

  var chatInput = document.createElement('input');
  chatInput.type = 'text';
  chatInput.placeholder = 'Type your question...';
  chatInput.style.cssText = 'flex:1;padding:12px;border:1px solid #d1d5db;border-radius:8px;outline:none;font-size:14px;height:40px;box-sizing:border-box;';

  var sendButton = document.createElement('button');
  sendButton.innerHTML = '‚û§';
  sendButton.style.cssText = 'background:' + config.primaryColor + ';color:white;border:none;border-radius:8px;padding:12px 16px;cursor:pointer;font-size:16px;height:40px;min-width:50px;';

  inputContainer.appendChild(chatInput);
  inputContainer.appendChild(sendButton);

  // Assemble chat widget
  chatWidget.appendChild(chatHeader);
  chatWidget.appendChild(messagesContainer);
  chatWidget.appendChild(inputContainer);

  // Add chat widget to container (after button)
  aiContainer.appendChild(chatWidget);

  console.log('Chat widget added to container');

  // State management
  var isOpen = false;
  var isLoading = false;

  // Chat toggle function
  function toggleChat() {
    isOpen = !isOpen;
    chatWidget.style.display = isOpen ? 'block' : 'none';
    chatButton.style.transform = isOpen ? 'scale(0.9)' : 'scale(1)';
  }

  // Add message to chat
  function addMessage(content, isUser, isError) {
    isUser = isUser || false;
    isError = isError || false;
    
    var messageDiv = document.createElement('div');
    var bgColor = isUser ? config.primaryColor : (isError ? '#ef4444' : 'white');
    var textColor = isUser ? 'white' : (isError ? 'white' : config.textColor);
    
    messageDiv.style.cssText = 'background:' + bgColor + ';color:' + textColor + ';padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);word-wrap:break-word;line-height:1.4;';
    messageDiv.innerHTML = (isUser ? '<strong>You:</strong><br>' : (isError ? '<strong>Error:</strong><br>' : '<strong>AI Assistant:</strong><br>')) + content;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Show loading indicator
  function showLoading() {
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-indicator';
    loadingDiv.style.cssText = 'background:white;padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    loadingDiv.innerHTML = '<strong>AI Assistant:</strong><br>ü§î Thinking...';
    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function hideLoading() {
    var loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
      loadingIndicator.remove();
    }
  }

  // Send message to API
  function sendMessage(question) {
    if (isLoading || !question.trim()) return;
    
    isLoading = true;
    addMessage(question, true);
    showLoading();
    
    fetch(config.apiUrl + '/api/ask-public', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        question: question,
        search_scope: 'all'
      })
    })
    .then(function(response) {
      hideLoading();
      if (response.ok) {
        return response.json().then(function(data) {
          return { data: data, status: response.status, ok: response.ok };
        });
      } else {
        // Handle non-OK responses
        if (response.status === 405) {
          throw new Error('API endpoint not found. Make sure your Next.js server is running on http://localhost:3000');
        } else if (response.status === 404) {
          throw new Error('API endpoint not found. The ask-public API might not be available.');
        } else {
          return response.text().then(function(text) {
            let errorMsg;
            try {
              const errorData = JSON.parse(text);
              errorMsg = errorData.answer || errorData.error || `Server error (${response.status})`;
            } catch (e) {
              errorMsg = `Server error (${response.status}): ${text || 'Unknown error'}`;
            }
            return { data: { error: errorMsg }, status: response.status, ok: false };
          });
        }
      }
    })
    .then(function(result) {
      if (result.ok) {
        var answer = result.data.answer || 'Sorry, I could not find an answer to your question.';
        
        // Format answer with sources if available
        if (result.data.sources && result.data.sources.length > 0) {
          answer += '<br><br><small><strong>Sources:</strong><br>';
          result.data.sources.forEach(function(source, index) {
            answer += (index + 1) + '. ' + source.text;
            if (source.filename) {
              answer += ' <em>(' + source.filename + ')</em>';
            }
            answer += '<br>';
          });
          answer += '</small>';
        }

        // Add stats if available
        if (result.data.stats) {
          answer += '<br><small><em>Searched ' + result.data.stats.documentsSearched + ' documents, found ' + result.data.stats.relevantDocuments + ' relevant matches.</em></small>';
        }

        // Add demo note if present
        if (result.data.demo_note) {
          answer += '<br><br><small style="color:#666;"><strong>Note:</strong> ' + result.data.demo_note + '</small>';
        }
        
        addMessage(answer);
      } else {
        var errorMsg = result.data.answer || result.data.error || 'Sorry, something went wrong. Please try again.';
        addMessage(errorMsg, false, result.status >= 500);
      }
      isLoading = false;
    })
    .catch(function(error) {
      hideLoading();
      console.error('Chat error:', error);
      
      if (error.message && error.message.includes('API endpoint not found')) {
        addMessage(error.message, false, true);
      } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
        addMessage('Cannot connect to the AI server. Please make sure your Next.js server is running at http://localhost:3000', false, true);
      } else if (error.message && error.message.includes('CORS')) {
        addMessage('Cross-origin request blocked. Please access this page from http://localhost:3000/test-ai-agent.html instead.', false, true);
      } else {
        addMessage('Connection error: ' + (error.message || 'Please check your internet connection and try again.'), false, true);
      }
      isLoading = false;
    });
  }

  // Event listeners
  chatButton.addEventListener('click', toggleChat);
  closeButton.addEventListener('click', toggleChat);
  
  // Add hover effect to close button
  closeButton.addEventListener('mouseenter', function() {
    this.style.background = 'rgba(255,255,255,0.2)';
  });
  
  closeButton.addEventListener('mouseleave', function() {
    this.style.background = 'none';
  });
  
  sendButton.addEventListener('click', function() {
    sendMessage(chatInput.value);
    chatInput.value = '';
  });
  
  chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage(chatInput.value);
      chatInput.value = '';
    }
  });

  // Hover effects
  chatButton.addEventListener('mouseenter', function() {
    this.style.background = config.hoverColor;
    this.style.transform = 'scale(1.1)';
  });
  
  chatButton.addEventListener('mouseleave', function() {
    this.style.background = config.primaryColor;
    this.style.transform = isOpen ? 'scale(0.9)' : 'scale(1)';
  });
  
  sendButton.addEventListener('mouseenter', function() {
    this.style.background = config.hoverColor;
  });
  
  sendButton.addEventListener('mouseleave', function() {
    this.style.background = config.primaryColor;
  });

  // Auto-focus input when chat opens
  var originalToggleChat = toggleChat;
  toggleChat = function() {
    originalToggleChat();
    if (isOpen) {
      setTimeout(function() { 
        chatInput.focus(); 
      }, 100);
    }
  };

  console.log('RAG AI Agent initialized successfully!');
})();
    </script>
</body>
</html>
