<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Agent Widget Test - External Website</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 20px;
        line-height: 1.6;
        background: #f8f9fa;
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .info {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #2196f3;
      }
      .success {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ AI Agent Widget Test Page</h1>

      <div class="info">
        <h3>üìã Test Instructions:</h3>
        <p>
          This page simulates an external website where your AI agent widget
          will be embedded.
        </p>
        <ol>
          <li>The AI agent widget should appear in the bottom-right corner</li>
          <li>Click the ü§ñ button to open the chat interface</li>
          <li>
            You'll need to authenticate first using your RAG application
            credentials
          </li>
          <li>
            Once authenticated, you can ask questions about your uploaded
            documents
          </li>
          <li>The widget should only access YOUR documents (user-specific)</li>
        </ol>
      </div>

      <div class="success">
        <strong>‚úÖ Widget Status:</strong> If you see the ü§ñ button in the
        bottom-right corner, the widget loaded successfully! <br /><br />
        <button
          onclick="debugAuth()"
          style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
          "
        >
          üîç Debug Authentication
        </button>
        <button
          onclick="openMainApp()"
          style="
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-left: 10px;
          "
        >
          üöÄ Open Main App
        </button>
        <div
          id="authDebug"
          style="
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            display: none;
          "
        ></div>

        <div
          style="
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
          "
        >
          <strong>‚ö†Ô∏è Cross-Domain Issue:</strong> The authentication token
          cannot be shared between the main app and this test page due to
          browser security. <br /><br />
          <strong>Solution:</strong>
          <ol style="margin: 10px 0">
            <li>
              Open the main app in another tab:
              <a
                href="https://messy-ragcx.vercel.app"
                target="_blank"
                style="color: #0066cc"
                >https://messy-ragcx.vercel.app</a
              >
            </li>
            <li>Sign in and upload some documents</li>
            <li>Generate the AI agent script from the main app</li>
            <li>Test the generated script on a real external website</li>
          </ol>
        </div>
      </div>

      <h2>Sample Content</h2>
      <p>
        This is a sample website where your AI agent widget is embedded. The
        widget should work independently of this website's content and maintain
        secure access to only your uploaded documents.
      </p>

      <h3>Features to Test:</h3>
      <ul>
        <li>Widget loads on external domain</li>
        <li>Authentication flow works correctly</li>
        <li>CORS headers allow cross-domain requests</li>
        <li>User-specific document filtering</li>
        <li>Real-time AI responses</li>
      </ul>

      <p>
        <strong>Production API URL:</strong> https://messy-ragcx.vercel.app/api
      </p>
      <p><strong>Test Date:</strong> <span id="currentDate"></span></p>
    </div>

    <!-- Your AI Agent Widget - Production Version -->
    <script>
      (function () {
        // Production Configuration - Dynamic API URL Detection
        var config = {
          apiUrl: "https://messy-ragcx.vercel.app",
          primaryColor: "#A259FF",
          hoverColor: "#7C3AED",
          textColor: "#333",
          backgroundColor: "#fff",
          userId: "external-site-user",
          userToken: null, // Will be set dynamically
        };

        // Authentication helper - Get user token from Supabase
        function getUserToken() {
          try {
            console.log("Searching for authentication token...");

            // Method 1: Check all localStorage keys for Supabase auth
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.includes("sb-") && key.includes("-auth-token")) {
                try {
                  const authData = JSON.parse(localStorage.getItem(key));
                  if (authData && authData.access_token) {
                    console.log("Found token via Supabase key:", key);
                    return authData.access_token;
                  }
                } catch (e) {
                  // Skip invalid JSON
                }
              }
            }

            // Method 2: Try standard supabase auth token key
            const session = JSON.parse(
              localStorage.getItem("supabase.auth.token") || "{}"
            );
            if (session && session.access_token) {
              console.log("Found token via standard key");
              return session.access_token;
            }

            // Method 3: Check for any auth-related keys
            const authKeys = ["supabase-auth-token", "auth-token", "session"];
            for (const authKey of authKeys) {
              try {
                const data = localStorage.getItem(authKey);
                if (data) {
                  const parsed = JSON.parse(data);
                  if (parsed && parsed.access_token) {
                    console.log("Found token via key:", authKey);
                    return parsed.access_token;
                  }
                }
              } catch (e) {
                // Skip invalid JSON
              }
            }

            // Method 4: Try to get from Supabase client if available
            if (typeof window !== "undefined" && window.supabase) {
              const session = window.supabase.auth.session();
              if (session && session.access_token) {
                console.log("Found token via window.supabase");
                return session.access_token;
              }
            }

            console.warn("No authentication token found in localStorage");
            console.log(
              "Available localStorage keys:",
              Object.keys(localStorage)
            );
            return null;
          } catch (error) {
            console.warn("Failed to get user token:", error);
            return null;
          }
        }

        // Initialize authentication token
        config.userToken = getUserToken();

        // Create AI Agent Container
        var aiContainer = document.createElement("div");
        aiContainer.id = "rag-ai-agent-production";
        aiContainer.style.cssText =
          "position:fixed;bottom:20px;right:20px;z-index:99999;font-family:Arial,sans-serif;";

        // Chat Widget (initially hidden)
        var chatWidget = document.createElement("div");
        chatWidget.style.cssText =
          "display:none;width:350px;height:500px;background:white;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.2);overflow:hidden;border:1px solid #e5e7eb;flex-direction:column;";

        // Chat Header
        var chatHeader = document.createElement("div");
        chatHeader.style.cssText =
          "background:" +
          config.primaryColor +
          ";color:white;padding:16px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;";

        var headerContent = document.createElement("div");
        headerContent.innerHTML =
          "<strong>ü§ñ Your Personal AI</strong><br><small>Searching only YOUR documents</small>";

        var closeButton = document.createElement("button");
        closeButton.innerHTML = "√ó";
        closeButton.style.cssText =
          "background:none;border:none;color:white;font-size:20px;cursor:pointer;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;";

        chatHeader.appendChild(headerContent);
        chatHeader.appendChild(closeButton);

        // Chat Messages Container
        var messagesContainer = document.createElement("div");
        messagesContainer.style.cssText =
          "height:320px;overflow-y:auto;padding:16px;background:#f9f9f9;flex:1;";

        // Initial welcome message
        var welcomeMsg = document.createElement("div");
        welcomeMsg.style.cssText =
          "background:white;padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);";
        welcomeMsg.innerHTML =
          "<strong>Your Personal AI:</strong><br>Hello! I can help you find information from YOUR uploaded documents. What would you like to know?";
        messagesContainer.appendChild(welcomeMsg);

        // Chat Input Container
        var inputContainer = document.createElement("div");
        inputContainer.style.cssText =
          "padding:16px;background:white;border-top:1px solid #e5e7eb;display:flex;gap:8px;min-height:70px;box-sizing:border-box;flex-shrink:0;";

        var chatInput = document.createElement("input");
        chatInput.type = "text";
        chatInput.placeholder = "Ask about your documents...";
        chatInput.style.cssText =
          "flex:1;padding:12px;border:1px solid #d1d5db;border-radius:8px;outline:none;font-size:14px;height:40px;box-sizing:border-box;background:white;";

        var sendButton = document.createElement("button");
        sendButton.innerHTML = "‚û§";
        sendButton.style.cssText =
          "background:" +
          config.primaryColor +
          ";color:white;border:none;border-radius:8px;padding:12px 16px;cursor:pointer;font-size:16px;height:40px;min-width:50px;";

        inputContainer.appendChild(chatInput);
        inputContainer.appendChild(sendButton);

        // Assemble chat widget
        chatWidget.appendChild(chatHeader);
        chatWidget.appendChild(messagesContainer);
        chatWidget.appendChild(inputContainer);

        // Floating Chat Button
        var chatButton = document.createElement("button");
        chatButton.style.cssText =
          "width:60px;height:60px;border-radius:50%;background:" +
          config.primaryColor +
          ";border:none;cursor:pointer;box-shadow:0 4px 16px rgba(162,89,255,0.4);color:white;font-size:24px;transition:all 0.3s ease;";
        chatButton.innerHTML = "ü§ñ";

        // Add to container
        aiContainer.appendChild(chatWidget);
        aiContainer.appendChild(chatButton);
        document.body.appendChild(aiContainer);

        // State management
        var isOpen = false;
        var isLoading = false;

        // Chat functions
        function toggleChat() {
          isOpen = !isOpen;
          chatWidget.style.display = isOpen ? "flex" : "none";
          chatButton.style.transform = isOpen ? "scale(0.9)" : "scale(1)";

          if (isOpen) {
            setTimeout(function () {
              chatInput.focus();
            }, 100);
          }
        }

        function addMessage(content, isUser = false, isError = false) {
          var messageDiv = document.createElement("div");
          var bgColor = isUser
            ? config.primaryColor
            : isError
              ? "#ef4444"
              : "white";
          var textColor = isUser
            ? "white"
            : isError
              ? "white"
              : config.textColor;

          messageDiv.style.cssText =
            "background:" +
            bgColor +
            ";color:" +
            textColor +
            ";padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);word-wrap:break-word;";
          messageDiv.innerHTML =
            (isUser
              ? "<strong>You:</strong><br>"
              : isError
                ? "<strong>Error:</strong><br>"
                : "<strong>Your AI:</strong><br>") + content;

          messagesContainer.appendChild(messageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show loading indicator
        function showLoading() {
          var loadingDiv = document.createElement("div");
          loadingDiv.id = "loading-indicator";
          loadingDiv.style.cssText =
            "background:white;padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);";
          loadingDiv.innerHTML =
            "<strong>Your AI:</strong><br>üîç Searching your documents...";
          messagesContainer.appendChild(loadingDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
          var loadingIndicator = document.getElementById("loading-indicator");
          if (loadingIndicator) {
            loadingIndicator.remove();
          }
        }

        // Send message to API with real authentication
        async function sendMessage(question) {
          if (isLoading || !question.trim()) return;

          // Refresh token if needed
          if (!config.userToken) {
            config.userToken = getUserToken();
          }

          if (!config.userToken) {
            addMessage(
              "Authentication required. Please log in to your main application first to access your documents.",
              false,
              true
            );
            return;
          }

          isLoading = true;
          addMessage(question, true);
          showLoading();

          try {
            const response = await fetch(config.apiUrl + "/api/ask-user", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + config.userToken,
              },
              body: JSON.stringify({
                question: question,
                search_scope: "user",
              }),
            });

            hideLoading();

            if (response.ok) {
              const data = await response.json();
              var answer =
                data.answer ||
                "Sorry, I could not find an answer in your documents.";

              if (data.stats) {
                answer +=
                  "<br><br><small><strong>üìä Search Stats:</strong><br>";
                answer +=
                  "‚Ä¢ Your documents searched: " +
                  (data.stats.documentsSearched || 0) +
                  "<br>";
                answer +=
                  "‚Ä¢ Relevant results: " +
                  (data.stats.relevantDocuments || 0) +
                  "</small>";
              }

              if (data.sources && data.sources.length > 0) {
                answer +=
                  "<br><br><small><strong>üìÑ Sources from your documents:</strong><br>";
                data.sources.forEach(function (source, index) {
                  answer += index + 1 + ". " + source.filename + "<br>";
                  answer += '   "' + source.text + '"<br>';
                });
                answer += "</small>";
              }

              answer +=
                "<br><br><small>üîí Searching only YOUR documents</small>";

              addMessage(answer);
            } else if (response.status === 401) {
              addMessage(
                "Authentication expired. Please refresh your main application and try again.",
                false,
                true
              );
            } else {
              const errorData = await response.json();
              addMessage(
                errorData.error ||
                  "Sorry, something went wrong. Please try again.",
                false,
                true
              );
            }
          } catch (error) {
            hideLoading();
            console.error("API Error:", error);
            addMessage(
              "Connection error. Please check that your server is running on " +
                config.apiUrl,
              false,
              true
            );
          }

          isLoading = false;
        }

        // Event listeners
        chatButton.addEventListener("click", toggleChat);
        closeButton.addEventListener("click", toggleChat);

        sendButton.addEventListener("click", function () {
          sendMessage(chatInput.value);
          chatInput.value = "";
        });

        chatInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage(chatInput.value);
            chatInput.value = "";
          }
        });

        // Hover effects
        chatButton.addEventListener("mouseenter", function () {
          this.style.background = config.hoverColor;
          this.style.transform = "scale(1.1)";
        });

        chatButton.addEventListener("mouseleave", function () {
          this.style.background = config.primaryColor;
          this.style.transform = isOpen ? "scale(0.9)" : "scale(1)";
        });

        sendButton.addEventListener("mouseenter", function () {
          this.style.background = config.hoverColor;
        });

        sendButton.addEventListener("mouseleave", function () {
          this.style.background = config.primaryColor;
        });

        console.log(
          "Production AI Agent initialized successfully for external site!"
        );
      })();

      // Debug function to help troubleshoot authentication
      function debugAuth() {
        const debugDiv = document.getElementById("authDebug");
        debugDiv.style.display = "block";

        let debugInfo = "<strong>Authentication Debug Info:</strong><br><br>";

        // Check localStorage
        debugInfo += "<strong>LocalStorage Keys:</strong><br>";
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);

          if (
            key.includes("supabase") ||
            key.includes("auth") ||
            key.includes("sb-")
          ) {
            debugInfo += `${key}: ${value.substring(0, 100)}...<br>`;
          }
        }

        debugInfo += "<br><strong>Current Status:</strong><br>";
        debugInfo += `Domain: ${window.location.hostname}<br>`;
        debugInfo += `Protocol: ${window.location.protocol}<br>`;
        debugInfo += `Full URL: ${window.location.href}<br>`;

        // Try to get token again
        const token = getUserTokenDebug();
        debugInfo += `<br><strong>Token Found:</strong> ${token ? "YES (" + token.substring(0, 20) + "...)" : "NO"}<br>`;

        debugDiv.innerHTML = debugInfo;
      }

      function getUserTokenDebug() {
        // Same logic as getUserToken but for debugging
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.includes("sb-") && key.includes("-auth-token")) {
            try {
              const authData = JSON.parse(localStorage.getItem(key));
              if (authData && authData.access_token) {
                return authData.access_token;
              }
            } catch (e) {}
          }
        }
        return null;
      }

      function openMainApp() {
        window.open("https://messy-ragcx.vercel.app", "_blank");
      }
    </script>

    <script>
      // Set current date
      document.getElementById("currentDate").textContent =
        new Date().toLocaleDateString();
    </script>
  </body>
</html>
